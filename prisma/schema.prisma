generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Project {
  id              String              @id @default(uuid())
  name            String
  description     String?             @db.Text
  ownerSquad      String
  pic             String
  type            String
  submissionDate  DateTime            @default(now())
  reviewDate      DateTime?
  decisionDate    DateTime?
  status          String              @default("Submitted")
  decision        String?
  mitigationNotes String?             @db.Text
  adrNumber       String?
  notes           String?             @db.Text
  slaDuration     Int                 @default(5)
  slaTarget       DateTime
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  attachments     Attachment[]
  docLinks        DocumentationLink[]
  followupTasks   FollowupTask[]
  history         ProjectHistory[]
}

model FollowupTask {
  id          String       @id @default(uuid())
  description String       @db.Text
  isCompleted Boolean      @default(false)
  dueDate     DateTime
  projectId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  action      String?      @db.Text
  attachments Attachment[]
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId], map: "FollowupTask_projectId_fkey")
}

model DocumentationLink {
  id        String   @id @default(uuid())
  url       String   @db.Text
  projectId String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId], map: "DocumentationLink_projectId_fkey")
}

model Attachment {
  id                  String             @id @default(uuid())
  filename            String
  path                String
  caption             String?
  mimeType            String             @default("application/octet-stream")
  createdAt           DateTime           @default(now())
  projectId           String?
  followupTaskId      String?
  sideQuestId         String?
  sideQuestFollowUpId String?
  followupTask        FollowupTask?      @relation(fields: [followupTaskId], references: [id], onDelete: Cascade)
  project             Project?           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sideQuestFollowUp   SideQuestFollowUp? @relation(fields: [sideQuestFollowUpId], references: [id], onDelete: Cascade)
  sideQuest           SideQuest?         @relation(fields: [sideQuestId], references: [id], onDelete: Cascade)

  @@index([followupTaskId], map: "Attachment_followupTaskId_fkey")
  @@index([projectId], map: "Attachment_projectId_fkey")
  @@index([sideQuestFollowUpId], map: "Attachment_sideQuestFollowUpId_fkey")
  @@index([sideQuestId], map: "Attachment_sideQuestId_fkey")
}

model Squad {
  id   Int    @id @default(autoincrement())
  name String @unique
}

model ArchivedProject {
  id              String                      @id
  name            String
  description     String?                     @db.Text
  ownerSquad      String
  pic             String
  type            String
  submissionDate  DateTime
  reviewDate      DateTime?
  decisionDate    DateTime?
  status          String
  decision        String?
  mitigationNotes String?                     @db.Text
  adrNumber       String?
  notes           String?                     @db.Text
  slaDuration     Int
  slaTarget       DateTime
  createdAt       DateTime
  updatedAt       DateTime
  archivedAt      DateTime                    @default(now())
  attachments     ArchivedAttachment[]
  docLinks        ArchivedDocumentationLink[]
  followupTasks   ArchivedFollowupTask[]
}

model ArchivedFollowupTask {
  id                String               @id @default(uuid())
  description       String               @db.Text
  isCompleted       Boolean
  dueDate           DateTime
  projectArchivedId String
  createdAt         DateTime
  updatedAt         DateTime
  action            String?              @db.Text
  attachments       ArchivedAttachment[]
  projectArchived   ArchivedProject      @relation(fields: [projectArchivedId], references: [id], onDelete: Cascade)

  @@index([projectArchivedId], map: "ArchivedFollowupTask_projectArchivedId_fkey")
}

model ArchivedDocumentationLink {
  id        String          @id @default(uuid())
  url       String          @db.Text
  projectId String
  project   ArchivedProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId], map: "ArchivedDocumentationLink_projectId_fkey")
}

model ArchivedSideQuest {
  id          String                      @id
  ticketCode  String
  questName   String
  instruction String
  requestDate DateTime
  requestor   String
  executor    String?
  dueDate     DateTime
  finishDate  DateTime?
  impactScore Int
  status      String
  createdAt   DateTime
  archivedAt  DateTime                    @default(now())
  attachments ArchivedAttachment[]
  followUps   ArchivedSideQuestFollowUp[]
}

model ArchivedSideQuestFollowUp {
  id          String               @id
  sideQuestId String
  date        DateTime
  action      String               @db.Text
  createdAt   DateTime
  attachments ArchivedAttachment[]
  sideQuest   ArchivedSideQuest    @relation(fields: [sideQuestId], references: [id], onDelete: Cascade)

  @@index([sideQuestId], map: "ArchivedSideQuestFollowUp_sideQuestId_fkey")
}

model ArchivedAttachment {
  id                     String                     @id
  filename               String
  path                   String
  caption                String?
  mimeType               String                     @default("application/octet-stream")
  createdAt              DateTime
  projectId              String?
  sideQuestId            String?
  sideQuestFollowUpId    String?
  archivedFollowupTaskId String?
  archivedFollowupTask   ArchivedFollowupTask?      @relation(fields: [archivedFollowupTaskId], references: [id], onDelete: Cascade)
  project                ArchivedProject?           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sideQuestFollowUp      ArchivedSideQuestFollowUp? @relation(fields: [sideQuestFollowUpId], references: [id], onDelete: Cascade)
  sideQuest              ArchivedSideQuest?         @relation(fields: [sideQuestId], references: [id], onDelete: Cascade)

  @@index([archivedFollowupTaskId], map: "ArchivedAttachment_archivedFollowupTaskId_fkey")
  @@index([projectId], map: "ArchivedAttachment_projectId_fkey")
  @@index([sideQuestFollowUpId], map: "ArchivedAttachment_sideQuestFollowUpId_fkey")
  @@index([sideQuestId], map: "ArchivedAttachment_sideQuestId_fkey")
}

model ProjectHistory {
  id        String   @id @default(uuid())
  projectId String
  changes   String   @db.LongText
  timestamp DateTime @default(now())
  actor     String?
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId], map: "ProjectHistory_projectId_fkey")
}

model SideQuest {
  id          String              @id @default(uuid())
  ticketCode  String
  questName   String              @default("Untitled Quest")
  instruction String              @db.Text
  requestDate DateTime            @default(now())
  requestor   String              @default("Unknown")
  executor    String?
  dueDate     DateTime
  impactScore Int
  status      String              @default("Submited")
  createdAt   DateTime            @default(now())
  finishDate  DateTime?
  attachments Attachment[]
  followUps   SideQuestFollowUp[]
}

model SideQuestFollowUp {
  id          String       @id @default(uuid())
  sideQuestId String
  date        DateTime     @default(now())
  action      String       @db.Text
  createdAt   DateTime     @default(now())
  attachments Attachment[]
  sideQuest   SideQuest    @relation(fields: [sideQuestId], references: [id], onDelete: Cascade)

  @@index([sideQuestId], map: "SideQuestFollowUp_sideQuestId_fkey")
}
